name: ðŸ§  Gravity Auto-Optimiser & Site Auditor

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write
  pages: write

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸŸ¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm install --silent
          sudo apt-get update
          sudo apt-get install -y jq

      # ------------------------------------------------------
      # Build + Export
      # ------------------------------------------------------
      - name: ðŸ—ï¸ Build Next.js & Export Static Site
        run: |
          export GITHUB_PAGES=true
          npm run build
          npx next export

      # ------------------------------------------------------
      # Lighthouse Audit
      # ------------------------------------------------------
      - name: ðŸ” Lighthouse Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            file:./out/index.html
          uploadArtifacts: true
          runs: 3

      # ------------------------------------------------------
      # Broken Link Checker
      # ------------------------------------------------------
      - name: ðŸ”— Broken Link Check
        uses: lycheeverse/lychee-action@v2
        with:
          args: --verbose --no-progress ./out

      # ------------------------------------------------------
      # HTML Validation
      # ------------------------------------------------------
      - name: ðŸ§¹ HTML Validator
        uses: Cyb3r-Jak3/html5validator-action@v1
        with:
          root: ./out

      # ------------------------------------------------------
      # Accessibility Audit
      # ------------------------------------------------------
      - name: â™¿ Accessibility Scan (axe-core)
        uses: pacoalfaro/axe-linter-action@v1
        with:
          directory: "./out"

      # ------------------------------------------------------
      # Image optimisation
      # ------------------------------------------------------
      - name: ðŸ–¼ï¸ Optimise Images
        run: |
          npm install sharp --silent
          node scripts/optimise-images.js

      # ------------------------------------------------------
      # SEO auto-fix
      # ------------------------------------------------------
      - name: ðŸ§  SEO Auto-Fix
        run: node scripts/seo-autofix.js

      # ------------------------------------------------------
      # A11y fixes
      # ------------------------------------------------------
      - name: â™»ï¸ Auto Fix Accessibility
        run: node scripts/a11y-fix.js

      # ------------------------------------------------------
      # Sitemap + Robots
      # ------------------------------------------------------
      - name: ðŸ—ºï¸ Generate sitemap.xml & robots.txt
        run: |
          node scripts/generate-sitemap.js
          node scripts/generate-robots.js

      # ------------------------------------------------------
      # Upload the processed static site as an artifact (NEW SYNTAX)
      # ------------------------------------------------------
      - name: ðŸ“¦ Upload Processed Static Site
        uses: actions/upload-artifact@v4
        with:
          name: gravity-site-out
          path: ./out
          if-no-files-found: error

      # ------------------------------------------------------
      # Commit changes back to repo
      # ------------------------------------------------------
      - name: ðŸ’¾ Commit & Push Fixes
        run: |
          git config user.name "Gravity Auto Optimiser"
          git config user.email "bot@gravitygrouprsa.co.za"
          git add .
          if git diff --cached --quiet; then
            echo "No fixes to commit"
          else
            git commit -m "Automated site improvements"
            git push
          fi

      # ------------------------------------------------------
      # Auto pull-request if heavy fixes detected
      # ------------------------------------------------------
      - name: ðŸ”€ Create Pull Request (Major Fixes)
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Automated Large Site Fixes"
          title: "Automated Site Optimisation PR"
          branch: "auto/site-improvement-${{ github.run_id }}"
          base: main
          body: |
            Automated improvements applied:
            - SEO enhancements
            - Accessibility fixes
            - Performance optimisations
            - HTML clean-up
            - Image optimisation

      # ------------------------------------------------------
      # GitHub Summary
      # ------------------------------------------------------
      - name: ðŸ“Š Summary
        run: |
          echo "### Gravity Group RSA â€” Auto Optimisation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse Passed" >> $GITHUB_STEP_SUMMARY
          echo "- SEO Checks Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility Scanned" >> $GITHUB_STEP_SUMMARY
          echo "- Images Optimised" >> $GITHUB_STEP_SUMMARY
          echo "- Sitemap & Robots Updated" >> $GITHUB_STEP_SUMMARY
