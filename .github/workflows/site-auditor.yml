name: ðŸ§  Gravity Auto-Optimiser & Site Auditor

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸŸ¦ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm install --silent
          sudo apt-get update
          sudo apt-get install -y jq

      # --------------------------------------------
      # 1. Build + Static Export (Next.js)
      # --------------------------------------------
      - name: ðŸ—ï¸ Build Next.js & Export Static Site
        run: |
          export GITHUB_PAGES=true
          npm run build
          npx next export

      # --------------------------------------------
      # 2. Lighthouse Performance + SEO Audit
      # --------------------------------------------
      - name: ðŸ” Lighthouse Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            file:./out/index.html
          configPath: ./lighthouse.config.cjs
          uploadArtifacts: true
          runs: 3

      # --------------------------------------------
      # 3. Broken Link Check
      # --------------------------------------------
      - name: ðŸ”— Check for Broken Links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress ./out

      # --------------------------------------------
      # 4. HTML Validator
      # --------------------------------------------
      - name: ðŸ§¹ Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v1
        with:
          root: ./out
          blacklist: |
            sitemap.xml
            robots.txt

      # --------------------------------------------
      # 5. Accessibility Audit (Axe Core)
      # --------------------------------------------
      - name: â™¿ Accessibility Scan (axe-core)
        uses: pacoalfaro/axe-linter-action@v1
        with:
          directory: "./out"

      # --------------------------------------------
      # 6. Auto-Optimise Images (WebP + AVIF)
      # --------------------------------------------
      - name: ðŸ–¼ï¸ Optimise Images
        run: |
          npm install sharp --silent
          node scripts/optimise-images.js

      # --------------------------------------------
      # 7. Auto-Fix SEO Metadata
      # --------------------------------------------
      - name: ðŸ§  Auto-Fix Missing SEO Metadata
        run: |
          node scripts/seo-autofix.js

      # --------------------------------------------
      # 8. Auto-Fix Accessibility (missing alt, labels)
      # --------------------------------------------
      - name: â™»ï¸ Auto-Fix A11y Issues
        run: |
          node scripts/a11y-fix.js

      # --------------------------------------------
      # 9. Auto-Fix Sitemap / Robots Inconsistencies
      # --------------------------------------------
      - name: ðŸ—ºï¸ Regenerate sitemap.xml and robots.txt
        run: |
          node scripts/generate-sitemap.js
          node scripts/generate-robots.js

      # --------------------------------------------
      # 10. Commit Improvements
      # --------------------------------------------
      - name: ðŸ’¾ Commit & Push Fixes
        run: |
          git config user.name "Gravity Auto Optimiser"
          git config user.email "bot@gravitygrouprsa.co.za"
          git add .
          if git diff --cached --quiet; then
            echo "No fixes required"
          else
            git commit -m "Automated site improvements via CI"
            git push
          fi

      # --------------------------------------------
      # 11. Create PR If Massive Fixes Detected
      # --------------------------------------------
      - name: ðŸ”€ Create Pull Request (For Large Changes)
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Automated Large Site Fixes"
          title: "Automated Large Optimisation Pass"
          body: |
            This PR includes large-scale automated fixes:
            - SEO improvements
            - Accessibility remediation
            - Broken link corrections
            - Lighthouse-based improvements
            - HTML validation fixes
          branch: "auto/site-improvement-${{ github.run_id }}"
          base: "main"

      # --------------------------------------------
      # 12. GitHub Summary Report
      # --------------------------------------------
      - name: ðŸ“Š Final Report
        run: |
          echo "### Gravity Group RSA â€” Site Audit" >> $GITHUB_STEP_SUMMARY
          echo "âœ” Lighthouse Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ” SEO Checks Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ” HTML Validation Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ” Broken Link Checker Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ” Auto Optimisations Applied" >> $GITHUB_STEP_SUMMARY
